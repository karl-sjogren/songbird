parameters:
  - name: environments
    type: object
    default: []

stages:
  - ${{ each environment in parameters.environments }}:
    - stage: Deploy_${{ environment.branch }}
      dependsOn: build
      displayName: Deploy branch ${{ environment.branch }} to environment ${{ environment.name }}
      condition: and(succeeded(), eq(variables['build.sourceBranch'], 'refs/heads/${{ environment.branch }}'))
      jobs:
      - job:
        pool:
          vmImage: windows-latest
        displayName: Build thing one
        steps:
          - task: CmdLine@2
            displayName: Deploy branch ${{ environment.branch }} to environment ${{ environment.name }}
            inputs:
              script: 'echo "Deploy branch ${{ environment.branch }} to environment ${{ environment.name }}"'
